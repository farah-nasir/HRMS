<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>HRMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
            body {
                background: #e0e5ec;
                font-family: 'Poppins', sans-serif;
            }

            /* Navbar */
            .navbar-custom {
                background: #e0e5ec;
                box-shadow: 3px 3px 8px #a3b1c6, -3px -3px 8px #ffffff;
                border-radius: 0 0 20px 20px;
            }

            .navbar-custom .navbar-brand,
            .navbar-custom .navbar-text,
            .navbar-custom .btn {
                color: #333;
            }

            h2 {
                color: #333;
                margin-bottom: 20px;
                margin-top: 20px;
                text-align: center;
            }

            .neomorph-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                box-shadow:  10px 10px 20px #b8bbc1, 
                            -10px -10px 20px #ffffff;
                border-radius: 20px;
                overflow: hidden;
                background: #e0e5ec;

            }

            .neomorph-table th, .neomorph-table td {
                padding: 15px;
                text-align: left;
            }

            .neomorph-table thead {
                background: #e0e5ec;
                box-shadow: inset 5px 5px 10px #b8bbc1,
                            inset -5px -5px 10px #ffffff;
            }

            .neomorph-table tbody tr {
                transition: all 0.2s ease-in-out;
            }

            .neomorph-table tbody tr:hover {
                background: #d9dee6;
                cursor: pointer;
            }

            .page-wrapper {
                max-width: 1400px;      
                margin: 0 auto;     
            }


            .table-btn {
                padding: 6px 12px;
                border-radius: 12px;
                border: none;
                background: #e0e5ec;
                box-shadow:  5px 5px 10px #b8bbc1,
                            -5px -5px 10px #ffffff;
                cursor: pointer;
                text-decoration: none;
                color: #333;
                font-weight: 500;
                transition: all 0.2s ease-in-out;
            }

            .table-btn:hover {
                box-shadow: inset 3px 3px 6px #b8bbc1,
                            inset -3px -3px 6px #ffffff;
            }

            .add-new-btn {
                display: block;
                width: 200px;
                margin: 0 auto 20px;
                padding: 10px;
                border-radius: 20px;
                text-align: center;
                text-decoration: none;
                color: #333;
                font-weight: bold;
                background: #e0e5ec;
                box-shadow:  5px 5px 10px #b8bbc1,
                            -5px -5px 10px #ffffff;
                transition: all 0.2s ease-in-out;
            }

            .add-new-btn:hover {
                box-shadow: inset 5px 5px 10px #b8bbc1,
                            inset -5px -5px 10px #ffffff;
            }



    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom px-5">
        <a class="navbar-brand" href="#">HRMS Dashboard</a>
        <div class="ms-auto d-flex align-items-center">
            <span class="navbar-text me-3" th:text="'Hello, ' + ${username}"></span>
            <a th:href="@{/logout}">
                <button type="button" class="btn btn-sm btn-danger text-white">Logout</button>
            </a>
        </div>
    </nav>
     <h2 th:text="${roleId == 2} ? 'List of Leave Applications' : 'List of Submitted Applications'"></h2>
        
        <div class="page-wrapper">
           <div class="btncontainer mb-3 d-flex justify-content-end gap-2">
                <a th:href="@{/dashboard}" class="btn btn-outline-secondary btn-sm">Back</a>
                
                <!-- Only show to employees -->
                <a th:if="${roleId == 3}" th:href="@{/Leave/new}" class="btn btn-outline-primary btn-sm">
                    New Leave
                </a>
            </div>

            <table class="neomorph-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Leave Reason</th>
                        <th>Reject Reason</th>
                        <th>Appeal Reason</th>
                        <th>Status</th>
                        <th>Submitted By</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Check if leaveApplications is empty -->
                    <tr th:if="${#lists.isEmpty(leaveApplications)}">
                        <td colspan="7" class="text-center">No Record</td>
                    </tr>

                    <!-- Loop through all leave applications -->
                    <tr th:each="leave, stat : ${leaveApplications}">
                        <td th:text="${stat.index + 1}"></td>
                        <td th:text="${leave.startDate}"></td>
                        <td th:text="${leave.endDate}"></td>
                        <td th:text="${leave.reason}"></td>
                        <td th:text="${leave.rejectReason != null && leave.rejectReason != '' ? leave.rejectReason : '-'}"></td>
                        <td th:text="${leave.appealReason != null && leave.appealReason != '' ? leave.appealReason : '-'}"></td>
                        <td th:text="${leave.status}"></td>
                        <td th:text="${leave.employee != null ? leave.employee.username : 'N/A'}"></td>
                    <td>
                    <!-- For Manager (role_id = 2) -->
                    <div th:if="${roleId == 2}">
                        <div th:if="${leave.status == 'PENDING' or leave.status == 'APPEALED'}">
                            <!-- Approve button -->
                            <a th:href="@{|/Leave/approve/${leave.id}|}" 
                            class="btn btn-outline-success btn-sm"
                            onclick="return confirm('Are you sure you want to approve this leave?')">
                                Approve
                            </a>

                            <!-- Reject button triggers modal for reason -->
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    data-bs-toggle="modal" 
                                    th:data-bs-target="'#rejectModal' + ${leave.id}">
                                Reject
                            </button>

                            <!-- Modal -->
                            <div class="modal fade" th:id="'rejectModal' + ${leave.id}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Reject Leave</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form th:action="@{/Leave/reject/{id}(id=${leave.id})}" method="post">
                                        <div class="modal-body">
                                        <label for="rejectReason">Reason:</label>
                                        <textarea name="rejectReason" class="form-control" required></textarea>
                                        </div>
                                        <div class="modal-footer">
                                        <button type="submit" class="btn btn-outline-success btn-sm">Submit</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${leave.status == 'APPROVED' or leave.status == 'REJECTED'}">
                            No Action Needed
                        </div>
                    </div>


                    <!-- For Employee (role_id = 3) -->
                <div th:if="${roleId == 3}">
                        <button th:if="${leave.status == 'REJECTED'}"
                                type="button" class="btn btn-outline-primary btn-sm"
                                data-bs-toggle="modal"
                                th:data-bs-target="'#appealModal' + ${leave.id}">
                            Appeal
                        </button>
                        <div class="modal fade" th:id="'appealModal' + ${leave.id}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Appeal Leave</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form th:action="@{/Leave/appeal/{id}(id=${leave.id})}" method="post">
                                        <div class="modal-body">
                                        <label for="appealReason">Reason:</label>
                                        <textarea name="appealReason" class="form-control" required></textarea>
                                        </div>
                                        <div class="modal-footer">
                                        <button type="submit" class="btn btn-outline-success btn-sm">Submit</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </form>
                                    </div>
                                </div>
                        </div>

                        <span th:if="${leave.status != 'REJECTED'}">
                            No Action Needed
                        </span>
                    </div>
                </td>
                    </tr>
                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
                </tbody>
            </table>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <!-- Summary -->
                <div>
                    <span th:text="'Showing ' 
                                    + ${(currentPage * pageSize) + 1} 
                                    + '–' 
                                    + ${((currentPage + 1) * pageSize) > totalItems ? totalItems : ((currentPage + 1) * pageSize)} 
                                    + ' of ' 
                                    + ${totalItems} 
                                    + ' records'">
                    </span>
                </div>

            <!-- Pagination Bar -->
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0">

                        <!-- Previous Button -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/Leave(page=${currentPage - 1}, size=${pageSize})}">Previous</a>
                        </li>

                        <!-- Page Numbers -->
                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(0, totalPages > 0 ? totalPages - 1 : 0)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                            th:text="${i + 1}"
                            th:href="@{/Leave(page=${i}, size=${pageSize})}"></a>
                        </li>

                        <!-- Next Button -->
                        <li class="page-item" th:classappend="${currentPage + 1 >= (totalPages > 0 ? totalPages : 1)} ? 'disabled'">
                            <a class="page-link" th:href="@{/Leave(page=${currentPage + 1}, size=${pageSize})}">Next</a>
                        </li>

                    </ul>
                </nav>

            </div>
        </div>
</body>
</html>
